<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Invoice App — Refit Interior</title>
<style>
  :root{
    --accent:#0b5f8a; --muted:#666; --bg:#f4f6f8; --text:#111;
    --pastel1:#d0e7ff; --pastel2:#d0ffd6; --pastel3:#fff5b1; 
    --pastel4:#ffd6b1; --pastel5:#ffc2d1; --pastel6:#e1d0ff;
    --night-bg:#1c1c1c; --night-text:#eee;
  }
  body{
    font-family:Inter,Segoe UI,Roboto,Arial;
    line-height:1.35;margin:0;background:var(--bg);color:var(--text);
    transition: background 0.3s, color 0.3s;
  }
  body.night{background:var(--night-bg); color:var(--night-text);}
  .app{max-width:1100px;margin:28px auto;padding:20px}
  h1{margin:0 0 12px;font-size:22px;color:var(--accent)}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:12px}
  .card{background:#fff;border-radius:8px;padding:14px;box-shadow:0 1px 3px rgba(15,20,30,0.06); transition: background 0.3s, color 0.3s;}
  body.night .card{background:#2a2a2a;}
  input,textarea,select{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px;background:#fff; color:#111;}
  body.night input,body.night textarea, body.night select{background:#444;color:#eee;border:1px solid #666;}
  label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .items-table{width:100%;border-collapse:collapse;margin-top:8px}
  .items-table th,.items-table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .items-table th{background:#fafafa;font-weight:600;color:#333}
  .muted{color:var(--muted);font-size:13px}
  .btn{display:inline-block;padding:8px 12px;border-radius:6px;border:0;cursor:pointer;font-weight:600}
  .btn-accent{background:var(--accent);color:#fff}
  .btn-ghost{background:#fff;border:1px solid #ddd}
  .flex{display:flex;gap:8px;align-items:center}
  .right{text-align:right}
  .invoice-preview{background:#fff;padding:18px;border-radius:8px;margin-top:12px}
  .invoice-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
  .logo{font-weight:800;color:var(--accent);font-size:18px}
  .small{font-size:13px;color:var(--muted)}
  .totals{width:320px;margin-left:auto}
  .totals div{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee}
  .no-print{display:block}
  @media print{
    body{background:white}
    .no-print{display:none}
    .app{margin:0;padding:0;max-width:100%}
  }
  .danger{color:#aa0000;font-weight:600}
  .section{padding:10px;border-radius:6px;margin-bottom:12px;}
  .section1{background:var(--pastel1);}
  .section2{background:var(--pastel2);}
  .section3{background:var(--pastel3);}
  .section4{background:var(--pastel4);}
  .section5{background:var(--pastel5);}
  .section6{background:var(--pastel6);}
</style>
</head>
<body>
  <div class="app">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h1>Smart Invoice App</h1>
      <div class="no-print flex">
        <button class="btn btn-accent" id="toggleMode">Night/Day Mode</button>
        <button class="btn btn-accent" id="btnPreview">Preview / Print</button>
        <button class="btn btn-ghost" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="grid" style="grid-template-columns:1fr 420px;gap:14px">

      <!-- Left Panel -->
      <div>
        <!-- Seller Info -->
        <div class="card section section1">
          <label>Seller / Company Info</label>
          <div class="two">
            <div>
              <input id="sellerName" placeholder="Business name" value="Refit Interior" readonly/>
              <input id="sellerReg" placeholder="SSM / Reg No." value="2025XXXXXX" readonly/>
              <textarea id="sellerAddress" rows="3" readonly>No. 1, Jalan Contoh, 43000 Kajang, Selangor</textarea>
            </div>
            <div>
              <label class="muted">Contact</label>
              <input id="sellerPhone" placeholder="Phone / Email" value="+60 12-345 6789" readonly/>
              <label class="muted">Bank details</label>
              <input id="bankName" value="Maybank" readonly/>
              <input id="bankAcc" value="123-456-789 (Refit Interior)" readonly/>
            </div>
          </div>
        </div>

        <!-- Buyer Info -->
        <div class="card section section2">
          <label>Buyer / Customer</label>
          <div class="two">
            <div>
              <input id="buyerName" placeholder="Customer name"/>
              <input id="buyerReg" placeholder="Company Reg No. (optional)"/>
              <textarea id="buyerAddress" rows="3" placeholder="Billing address"></textarea>
            </div>
            <div>
              <label class="muted">Invoice details</label>
              <input id="invoiceNumber" placeholder="Invoice number" readonly/>
              <input id="invoiceDate" type="date"/>
              <input id="dueDate" type="date" placeholder="Due date"/>
              <label class="muted">SST / Tax (%)</label>
              <input id="taxRate" type="number" min="0" step="0.1" value="0"/>
            </div>
          </div>
        </div>

        <!-- Invoice Items -->
        <div class="card section section3">
          <label>Invoice Items</label>
          <table class="items-table" id="itemsTable">
            <thead>
              <tr><th>Description</th><th>Qty</th><th>Unit (RM)</th><th>Total (RM)</th><th></th></tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>
          <div style="margin-top:8px">
            <button class="btn btn-ghost" id="addItem">+ Add item</button>
            <span class="muted" style="margin-left:12px">Tip: use "Design fee / Labour / Materials".</span>
          </div>
        </div>

        <!-- Notes -->
        <div class="card section section5 no-print">
          <label>Notes</label>
          <textarea id="notes" rows="3" placeholder="Payment within 14 days."></textarea>
        </div>
      </div>

      <!-- Right Panel -->
      <div>
        <div class="card section section4">
          <label class="muted">Quick totals</label>
          <div style="font-size:28px;font-weight:700;color:#222;padding:10px 0" id="grandTotal">RM 0.00</div>
          <div class="muted" style="margin-top:6px">Subtotal and tax shown in preview.</div>
        </div>

        <div class="card section section6">
          <div style="display:flex;gap:10px;flex-direction:column">
            <button class="btn btn-accent no-print" id="btnFillSample">Fill sample data</button>
            <button class="btn btn-ghost no-print" id="btnExportJSON">Save (JSON)</button>
            <button class="btn btn-ghost no-print" id="btnLoadJSON">Load (JSON)</button>
            <input type="file" id="fileInput" style="display:none"/>
            <button class="btn btn-accent no-print" id="btnGenerateReceipt">Generate Receipt</button>
            <button class="btn btn-accent no-print" id="btnGenerateDO">Generate DO</button>
            <button class="btn btn-accent no-print" id="btnGenerateHandover">Generate Handover</button>
          </div>
          <div style="margin-top:12px" class="small muted">
            Use browser Print → Save as PDF for any document.<br/>
            All data stays local unless exported.
          </div>
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div id="previewArea" class="invoice-preview" style="display:none"></div>

  </div>

<script>
  const $=id=>document.getElementById(id);
  const fmt=n=>'RM '+Number(n||0).toLocaleString('en-MY',{minimumFractionDigits:2,maximumFractionDigits:2});

  // Day/Night mode toggle
  $('toggleMode').onclick = ()=>{ document.body.classList.toggle('night'); }

  // Auto-increment running invoice number
  let invoiceCounter = 1;
  function generateInvoiceNumber(){
    const year = new Date().getFullYear();
    return 'REF-'+year+'-'+String(invoiceCounter++).padStart(3,'0');
  }

  // Create row
  const itemsBody = $('itemsBody');
  function createRow(desc='', qty=1, unit=0){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><input value="${desc}" placeholder="Description" oninput="updateAll()"></td>
                    <td><input type="number" min="0" step="1" value="${qty}" oninput="updateAll()"></td>
                    <td><input type="number" min="0" step="0.01" value="${unit}" oninput="updateAll()"></td>
                    <td class="right">${fmt(qty*unit)}</td>
                    <td><button class="btn btn-ghost" onclick="this.closest('tr').remove(); updateAll();">Remove</button></td>`;
    itemsBody.appendChild(tr);
    updateAll();
  }

  function readRows(){
    return [...itemsBody.querySelectorAll('tr')].map(tr=>{
      const inputs = tr.querySelectorAll('input');
      return {desc:inputs[0].value, qty:Number(inputs[1].value), unit:Number(inputs[2].value)};
    });
  }

  function updateAll(){
    let subtotal=0;
    [...itemsBody.querySelectorAll('tr')].forEach(tr=>{
      const inputs=tr.querySelectorAll('input');
      const qty=Number(inputs[1].value)||0;
      const unit=Number(inputs[2].value)||0;
      tr.children[3].textContent=fmt(qty*unit);
      subtotal+=qty*unit;
    });
    const taxRate=Number($('taxRate').value)||0;
    const tax=subtotal*taxRate/100;
    const grand=subtotal+tax;
    $('grandTotal').textContent=fmt(grand);
  }

  $('addItem').onclick = ()=>createRow('','1','0.00');

  $('btnPreview').onclick = ()=>{
    if(itemsBody.children.length===0) createRow('Service','1','0.00');
    updateAll();
    const rows = readRows();
    const d = $('invoiceDate').value ? new Date($('invoiceDate').value) : new Date();
    const due = $('dueDate').value ? new Date($('dueDate').value) : new Date(d.getTime()+14*24*60*60*1000);
    const previewHTML = `
      <div class="invoice-header">
        <div><div class="logo">${$('sellerName').value}</div>
        <div class="small">${$('sellerAddress').value}</div>
        <div class="small">${$('sellerPhone').value}</div>
        <div class="small">${$('bankName').value} • ${$('bankAcc').value}</div></div>
        <div style="text-align:right">
          <div class="small">Invoice</div>
          <div style="font-weight:700;font-size:18px">${$('invoiceNumber').value}</div>
          <div class="small">${d.toLocaleDateString()}</div>
          <div class="small">Due: ${due.toLocaleDateString()}</div>
        </div>
      </div>
      <hr>
      <div style="display:flex;justify-content:space-between">
        <div><div class="small">Bill to</div>
        <div style="font-weight:700">${$('buyerName').value}</div>
        <div class="small">${$('buyerAddress').value}</div></div>
        <div class="small">${$('buyerReg').value ? 'Reg No: '+$('buyerReg').value : ''}</div>
      </div>
      <table class="items-table" style="margin-top:10px">
        <thead><tr><th>Description</th><th>Qty</th><th>Unit (RM)</th><th>Total (RM)</th></tr></thead>
        <tbody>${rows.map(r=>`<tr><td>${r.desc}</td><td>${r.qty}</td><td>${fmt(r.unit).replace('RM ','')}</td><td class="right">${fmt(r.qty*r.unit)}</td></tr>`).join('')}</tbody>
      </table>
      <div class="totals" style="margin-top:12px">
        <div><div class="small">Subtotal</div><div class="right small">${fmt(rows.reduce((a,b)=>a+b.qty*b.unit,0))}</div></div>
        <div><div class="small">SST (${Number($('taxRate').value).toFixed(1)}%)</div><div class="right small">${fmt(rows.reduce((a,b)=>a+b.qty*b.unit,0)*Number($('taxRate').value)/100)}</div></div>
        <div style="font-weight:700;font-size:18px"><div>Total</div><div class="right">${fmt(rows.reduce((a,b)=>a+b.qty*b.unit,0)*(1+Number($('taxRate').value)/100))}</div></div>
      </div>
      <div style="margin-top:18px" class="small">${$('notes').value}</div>`;
    $('previewArea').innerHTML = previewHTML;
    $('previewArea').style.display='block';
    window.scrollTo(0, document.body.scrollHeight);
    setTimeout(()=>window.print(),600);
  }

  $('btnReset').onclick = ()=>location.reload();

  $('btnFillSample').onclick = ()=>{
    $('buyerName').value='Client Sdn Bhd';
    $('buyerAddress').value='No. 2, Jalan Utama, 43000 Kajang';
    $('invoiceNumber').value=generateInvoiceNumber();
    const today = new Date().toISOString().slice(0,10);
    $('invoiceDate').value=today;
    const due = new Date(); due.setDate(due.getDate()+14);
    $('dueDate').value=due.toISOString().slice(0,10);
    $('taxRate').value=0;
    $('notes').value='Payment due within 14 days. Please transfer to bank account above.';
    itemsBody.innerHTML='';
    createRow('Design fee (flat rate)',1,1200.00);
    createRow('Materials (tiles, paints)',1,650.00);
    createRow('Labour (installation)',8,80.00);
  }

  // JSON save/load
  $('btnExportJSON').onclick = ()=>{
    const payload={sellerName:$('sellerName').value,sellerReg:$('sellerReg').value,sellerAddress:$('sellerAddress').value,
      sellerPhone:$('sellerPhone').value,bankName:$('bankName').value,bankAcc:$('bankAcc').value,
      buyerName:$('buyerName').value,buyerReg:$('buyerReg').value,buyerAddress:$('buyerAddress').value,
      invoiceNumber:$('invoiceNumber').value,invoiceDate:$('invoiceDate').value,dueDate:$('dueDate').value,
      taxRate:$('taxRate').value,notes:$('notes').value,items:readRows()};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(payload.invoiceNumber||'invoice')+'.json'; a.click();
    URL.revokeObjectURL(a.href);
  }

  $('btnLoadJSON').onclick = ()=>$('fileInput').click();
  $('fileInput').onchange = e=>{
    const f = e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=function(){
      try{
        const obj=JSON.parse(r.result);
        Object.keys(obj).forEach(k=>{if($(k)) $(k).value=obj[k];});
        itemsBody.innerHTML='';
        (obj.items||[]).forEach(it=>createRow(it.desc,it.qty,it.unit));
        updateAll();
      }catch(err){alert('Failed to load: '+err.message);}
    }; r.readAsText(f);
  }

  // Generate Receipt / DO / Handover letter
  function generateSimpleDoc(title){
    if(itemsBody.children.length===0) createRow('Service','1','0.00');
    updateAll();
    const rows = readRows();
    const today = new Date();
    const html = `<h2>${title}</h2>
    <p>Date: ${today.toLocaleDateString()}</p>
    <p>From: ${$('sellerName').value}, ${$('sellerAddress').value}</p>
    <p>To: ${$('buyerName').value}, ${$('buyerAddress').value}</p>
    <table class="items-table" style="margin-top:10px">
      <thead><tr><th>Description</th><th>Qty</th><th>Unit (RM)</th><th>Total (RM)</th></tr></thead>
      <tbody>${rows.map(r=>`<tr><td>${r.desc}</td><td>${r.qty}</td><td>${fmt(r.unit).replace('RM ','')}</td><td class="right">${fmt(r.qty*r.unit)}</td></tr>`).join('')}</tbody>
    </table>`;
    const win=window.open(); win.document.write(html); win.print();
  }
  $('btnGenerateReceipt').onclick=()=>generateSimpleDoc('Receipt');
  $('btnGenerateDO').onclick=()=>generateSimpleDoc('Delivery Order (DO)');
  $('btnGenerateHandover').onclick=()=>generateSimpleDoc('Project Completion / Handover Letter');

  // init first row
  createRow('','1','0.00');
</script>
</body>
</html>

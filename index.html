<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Refit e-Invoice System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:20px}
.invoice{background:#fff;padding:25px;max-width:950px;margin:auto;border:1px solid #000}
h2{text-align:right;margin:0}
input,textarea,select{width:100%;border:1px solid #000;padding:5px;font-size:13px}
textarea{resize:none}
.header{display:flex;justify-content:space-between;margin-bottom:15px}
.box{width:48%}
label{font-weight:bold;font-size:12px;margin-top:4px;display:block}
table{width:100%;border-collapse:collapse;margin-top:10px}
table,th,td{border:1px solid #000}
th,td{padding:6px;font-size:13px}
.right{text-align:right}
button{border:1px solid #000;background:#eee;color:#000;padding:6px 10px;margin:4px;cursor:pointer}
.signature{margin-top:35px;display:flex;justify-content:space-between}
.sig-box{width:45%;border-top:1px dotted #000;text-align:center;padding-top:5px}
#logo{max-height:70px}

@media print{.no-print{display:none}}
</style>
</head>

<body>

<div class="no-print">
<button onclick="setDoc('INVOICE')">Invoice</button>
<button onclick="setDoc('QUOTATION')">Quotation</button>
<button onclick="setDoc('DELIVERY ORDER')">DO</button>
<button onclick="setDoc('RECEIPT')">Receipt</button>
<button onclick="window.print()">Print</button>
<button onclick="generatePDF()">Generate PDF</button><br><br>

<label>Upload Logo</label>
<input type="file" onchange="loadLogo(event)">

<label>Buyer Signature</label>
<input type="file" onchange="loadBuyerSign(event)">
<label>Seller Signature</label>
<input type="file" onchange="loadSellerSign(event)">
</div>

<div class="invoice" id="invoice">

<img id="logo">
<h2 id="docTitle">INVOICE</h2>

<div class="header">
<div class="box">
<label>Seller Name</label>
<input value="Refit Maintenance Services">

<label>Business Category</label>
<input value="Maintenance & Interior Services">

<label>Business Type</label>
<input value="Sole Proprietorship">

<label>Reg No</label>
<input value="201803348973">

<label>TIN</label>
<input value="OG 10451781060">

<label>Address</label>
<textarea rows="3">C-08-34, Centum @ Oasis Corporate Park, Oasis Damansara, No.2 Jalan PJU 1A/2, Ara Damansara, 47301 Petaling Jaya, Selangor Darul Ehsan, West Malaysia.</textarea>

<label>Bank</label>
<input value="RHB Bank">

<label>Account No</label>
<input value="2126 1100 0235 58">
</div>

<div class="box">
<label>Select Buyer</label>
<select id="buyerSelect" onchange="loadBuyer()"></select>

<label>Buyer Name</label>
<input id="bName" oninput="saveBuyer()">

<label>Business Category</label>
<input id="bCat" oninput="saveBuyer()">

<label>Buyer TIN</label>
<input id="bTIN" oninput="saveBuyer()">

<label>Buyer Reg No</label>
<input id="bReg" oninput="saveBuyer()">

<label>Buyer Address</label>
<textarea id="bAddr" rows="3" oninput="saveBuyer()"></textarea>

<label>Contact</label>
<input id="bContact" oninput="saveBuyer()">

<label>Email</label>
<input id="bEmail" oninput="saveBuyer()">

<button class="no-print" onclick="deleteBuyer()">Delete Buyer</button>
</div>
</div>

<table>
<tr>
<td>Document No</td>
<td><input id="docNo" readonly></td>
<td>Date</td>
<td><input type="date"></td>
</tr>
<tr>
<td>UUID</td>
<td colspan="3"><input id="uuid" readonly></td>
</tr>
</table>

<table id="itemTable">
<tr>
<th>Description</th>
<th>Qty</th>
<th>Unit Price</th>
<th>Amount</th>
<th class="no-print">‚ùå</th>
</tr>
</table>

<button class="no-print" onclick="addRow()">Add Item</button>

<table>
<tr>
<td colspan="3" class="right"><b>Total</b></td>
<td id="grandTotal">0.00</td>
<td class="no-print"></td>
</tr>
</table>

<label>Amount in Words</label>
<input id="words">

<div id="qrcode" style="margin-top:15px"></div>

<div class="signature">
<div class="sig-box"><img id="buyerSign" style="max-height:60px"><br>Buyer Signature</div>
<div class="sig-box"><img id="sellerSign" style="max-height:60px"><br><b>Refit Maintenance Services</b></div>
</div>

</div>

<script>
document.querySelector('input[type=date]').value=new Date().toISOString().slice(0,10)
document.getElementById("uuid").value=crypto.randomUUID()

function generateDocNo(p){
let y=new Date().getFullYear()
let k=p+"-"+y
let r=parseInt(localStorage.getItem(k)||0)+1
localStorage.setItem(k,r)
return `${p}-${y}-${String(r).padStart(3,'0')}`
}

function setDoc(t){
let m={INVOICE:"INV",QUOTATION:"QTN","DELIVERY ORDER":"DO",RECEIPT:"RCP"}
docTitle.innerText=t
docNo.value=generateDocNo(m[t])
}

function addRow(){
let r=itemTable.insertRow()
r.innerHTML=`<td contenteditable></td>
<td contenteditable oninput="calc()"></td>
<td contenteditable oninput="calc()"></td>
<td class="right">0.00</td>
<td class="no-print"><button onclick="this.closest('tr').remove();calc()">X</button></td>`
}
addRow()

function calc(){
let t=0
document.querySelectorAll("#itemTable tr").forEach((r,i)=>{
if(i>0){
let q=parseFloat(r.cells[1].innerText)||0
let p=parseFloat(r.cells[2].innerText)||0
let a=q*p
r.cells[3].innerText=a.toFixed(2)
t+=a
}})
grandTotal.innerText=t.toFixed(2)
words.value=t.toFixed(2)+" RINGGIT MALAYSIA"
qrcode.innerHTML=""
new QRCode(qrcode,{text:uuid.value,width:90,height:90})
}

function saveBuyer(){
let n=bName.value
if(!n)return
let d={name:n,cat:bCat.value,tin:bTIN.value,reg:bReg.value,addr:bAddr.value,contact:bContact.value,email:bEmail.value}
localStorage.setItem("buyer_"+n,JSON.stringify(d))
loadBuyerList()
}

function loadBuyerList(){
buyerSelect.innerHTML="<option value=''>-- Select Buyer --</option>"
Object.keys(localStorage).filter(k=>k.startsWith("buyer_")).forEach(k=>{
let o=document.createElement("option")
o.value=k
o.text=k.replace("buyer_","")
buyerSelect.appendChild(o)
})
}

function loadBuyer(){
let k=buyerSelect.value
if(!k)return
let d=JSON.parse(localStorage.getItem(k))
bName.value=d.name
bCat.value=d.cat
bTIN.value=d.tin
bReg.value=d.reg
bAddr.value=d.addr
bContact.value=d.contact
bEmail.value=d.email
}

function deleteBuyer(){
let k=buyerSelect.value
if(!k)return
localStorage.removeItem(k)
loadBuyerList()
}

function generatePDF(){html2pdf().from(invoice).save()}
function loadLogo(e){let r=new FileReader();r.onload=()=>logo.src=r.result;r.readAsDataURL(e.target.files[0])}
function loadBuyerSign(e){let r=new FileReader();r.onload=()=>buyerSign.src=r.result;r.readAsDataURL(e.target.files[0])}
function loadSellerSign(e){let r=new FileReader();r.onload=()=>sellerSign.src=r.result;r.readAsDataURL(e.target.files[0])}

window.onload=()=>{setDoc("INVOICE");loadBuyerList()}
</script>

</body>
</html>

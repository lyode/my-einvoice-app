<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Invoice â€” Refit Maintenance Services</title>
<style>
  :root{--bg:#fff;--text:#111;--card:#f7f8fb;--accent:#DFE7FD}
  body.dark{--bg:#121214;--text:#eef2f3;--card:#1e1f22;--accent:#2b2f33}
  /* pastel themes */
  body.theme1{--accent:#FDE2E4} body.theme2{--accent:#FFF1E6}
  body.theme3{--accent:#F0EFEB} body.theme4{--accent:#DFE7FD}
  body.theme5{--accent:#E2ECE9} body.theme6{--accent:#F9E5C8}
  body.theme7{--accent:#F6DFEB} body.theme8{--accent:#E8F3D6}
  body.theme9{--accent:#DDF1F0} body.theme10{--accent:#FCE2CE}
  body.theme11{--accent:#E6E6FA} body.theme12{--accent:#E0FFD1}

  body{background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica;margin:18px;transition:0.26s}
  .top-controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.03)}
  h1{margin:6px 0 12px}
  input,textarea,select,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #cfcfcf}
  textarea{resize:vertical}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .header{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#fff)}
  .logo-preview{max-height:72px;object-fit:contain}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left}
  .right{text-align:right}
  .muted{color:gray;font-size:13px}
  .small{font-size:13px}
  .btn{cursor:pointer;border:0;padding:8px 12px;border-radius:8px;font-weight:700}
  .btn-primary{background:#0b5f8a;color:#fff}
  .btn-ghost{background:#fff;border:1px solid #d0d0d0}
  .controls-left{display:flex;gap:8px;align-items:center}
  .theme-grid{display:flex;gap:6px;flex-wrap:wrap}
  .theme-swatch{width:28px;height:20px;border-radius:6px;cursor:pointer;border:1px solid rgba(0,0,0,0.08)}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .right-col{width:360px}
  .no-print{display:block}
  @media print{ .no-print{display:none} body{margin:0} }
  .disabled{opacity:0.5;pointer-events:none}
  .note{font-size:13px;color:#4a4a4a}
</style>
</head>
<body class="theme1">

<div class="top-controls">
  <div class="controls-left">
    <button class="btn btn-ghost" onclick="toggleDark()">ðŸŒ— Day/Night</button>
    <label class="small" style="display:inline-flex;align-items:center;gap:8px">Theme:
      <select id="themeSelect" onchange="changeTheme(this.value)">
        <option value="theme1">Pastel Pink</option><option value="theme2">Cream</option><option value="theme3">Beige</option>
        <option value="theme4">Lavender Blue</option><option value="theme5">Mint</option><option value="theme6">Warm Sand</option>
        <option value="theme7">Rose Blush</option><option value="theme8">Light Sage</option><option value="theme9">Aqua Soft</option>
        <option value="theme10">Peach Cream</option><option value="theme11">Lilac Soft</option><option value="theme12">Pastel Green</option>
      </select>
    </label>
    <label class="small" style="margin-left:6px"><input type="checkbox" id="appsToggle" onchange="toggleApps(this.checked)"/> Activate Apps</label>
  </div>

  <div style="display:flex;gap:8px">
    <button class="btn btn-primary" id="exportJsonBtn" onclick="exportJSON()" disabled>Export JSON</button>
    <button class="btn btn-ghost" id="printBtn" onclick="printPreview()">Preview / Print</button>
  </div>
</div>

<!-- Header / Company -->
<div class="header card" style="margin-bottom:12px">
  <div>
    <div style="font-weight:800;font-size:20px">Refit Maintenance Services</div>
    <div class="muted small">SSM Reg No: <strong>201803348973</strong> â€¢ Sole proprietorship</div>
    <div style="margin-top:8px" class="small">
      OG: 10451781060<br>
      C-08-34, Centum @ Oasis Corporate Park, Oasis Damansara<br>
      No. 2, Jalan PJU 1A/2, Ara Damansara, 47301 Petaling Jaya<br>
      Selangor Darul Ehsan<br>
      <strong>Phone:</strong> +60122145922 â€¢ <strong>Email:</strong> lyodengck@gmail.com<br>
      <strong>Bank (RHB):</strong> 21261100023558
    </div>
  </div>
  <div style="text-align:right">
    <!-- Put your logo file in same folder, filename below -->
    <img id="logoImg" class="logo-preview" src="CB93A44D-3626-47FE-9844-926D465D083E.jpeg" alt="Refit Logo" onerror="this.style.display='none'"/>
    <div class="muted small" style="margin-top:8px">Invoice Template</div>
  </div>
</div>

<div class="row" style="gap:18px">
  <!-- Left form -->
  <div style="flex:1">
    <div class="card">
      <div class="flex-between" style="align-items:center">
        <strong>Invoice Details</strong>
        <div class="muted small">Invoice no will auto-save</div>
      </div>
      <div style="margin-top:8px">
        <div class="row">
          <div class="col">
            <label class="small">Invoice Number</label>
            <input id="invoiceNumber" type="text"/>
          </div>
          <div class="col">
            <label class="small">Invoice Date</label>
            <input id="invoiceDate" type="date"/>
          </div>
        </div>

        <div style="margin-top:10px" class="flex-between">
          <div style="flex:1">
            <label class="small">Document Type</label>
            <select id="documentType"><option>INVOICE</option><option>CREDIT_NOTE</option></select>
          </div>
          <div style="width:180px">
            <label class="small">Currency</label>
            <input id="currency" value="MYR"/>
          </div>
        </div>
      </div>
    </div>

    <!-- Buyer card (auto-store + auto-fill) -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Buyer (saved templates)</strong>
        <div class="muted small">Once saved, details auto-fill future invoices</div>
      </div>

      <div style="margin-top:8px" class="row">
        <div class="col">
          <label class="small">Choose saved buyer</label>
          <select id="buyerSelect"><option value="">-- Select buyer --</option></select>
        </div>
        <div style="width:160px">
          <label class="small">Action</label><br>
          <button class="btn btn-ghost" onclick="loadSelectedBuyer()">Load</button>
        </div>
      </div>

      <div style="margin-top:8px">
        <label class="small">Buyer Name</label>
        <input id="buyerName"/>
        <label class="small" style="margin-top:6px">Buyer Reg / ID</label>
        <input id="buyerReg"/>
        <label class="small" style="margin-top:6px">Buyer Address</label>
        <textarea id="buyerAddress" rows="3"></textarea>
        <div class="row" style="margin-top:8px">
          <div class="col">
            <label class="small">Phone</label><input id="buyerPhone"/>
          </div>
          <div class="col">
            <label class="small">Email</label><input id="buyerEmail"/>
          </div>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn btn-primary" id="saveBuyerBtn" onclick="saveBuyer()">Save Buyer</button>
          <button class="btn btn-ghost" onclick="clearBuyerForm()">Clear</button>
          <button class="btn btn-ghost" onclick="deleteSelectedBuyer()">Delete Selected</button>
        </div>
      </div>
    </div>

    <!-- Items -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Items</strong>
        <div class="muted small">Line-level taxation supported</div>
      </div>
      <table id="itemsTable" style="margin-top:8px">
        <thead><tr><th>#</th><th>Description</th><th>UOM</th><th>Qty</th><th>Unit (RM)</th><th>Total (RM)</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="addItem()">+ Add item</button>
        <div class="muted small" style="margin-left:auto">Tax % <input id="taxRate" type="number" value="0" style="width:80px;margin-left:6px"/> applied to subtotal</div>
      </div>
    </div>

    <!-- Notes & actions -->
    <div class="card" style="margin-top:12px">
      <label class="small">Notes</label>
      <textarea id="notes" rows="3">Payment due within 14 days.</textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-primary" id="orderBtn" onclick="placeOrder()" disabled>Place Order</button>
        <button class="btn btn-ghost" onclick="exportJSON()">Export e-Invoice JSON</button>
        <button class="btn btn-ghost" onclick="previewInvoice()">Preview Invoice</button>
        <button class="btn btn-ghost" onclick="resetForm()">Reset</button>
      </div>
      <div class="note" style="margin-top:8px">Order button is active when buyer details are filled. Saved orders are stored locally.</div>
    </div>

  </div>

  <!-- Right column: Preview & summary -->
  <div class="right-col">
    <div class="card">
      <strong>Invoice Preview</strong>
      <div id="previewArea" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>Saved Orders</strong>
      <div id="ordersList" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>Storage / Apps</strong>
      <div style="margin-top:8px" class="small muted">LocalStorage status:</div>
      <div style="margin-top:8px">
        <div>Buyers: <span id="countBuyers">0</span></div>
        <div>Orders: <span id="countOrders">0</span></div>
      </div>
      <div style="margin-top:8px">
        <button class="btn btn-ghost" onclick="exportAllData()">Export All Data (JSON)</button>
        <button class="btn btn-ghost" onclick="clearAllData()">Clear All Local Data</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Utilities & localStorage keys ---------- */
const KEY_BUYERS = 'refit_buyers_v1';
const KEY_ORDERS = 'refit_orders_v1';
const KEY_LAST_INV = 'refit_last_invoice_v1';

function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

function loadBuyers(){ try { return JSON.parse(localStorage.getItem(KEY_BUYERS) || '[]'); } catch(e){ return []; } }
function saveBuyers(arr){ localStorage.setItem(KEY_BUYERS, JSON.stringify(arr)); updateBuyerSelect(); updateCounts(); }
function loadOrders(){ try { return JSON.parse(localStorage.getItem(KEY_ORDERS) || '[]'); } catch(e){ return []; } }
function saveOrders(arr){ localStorage.setItem(KEY_ORDERS, JSON.stringify(arr)); updateOrdersList(); updateCounts(); }
function updateCounts(){ $('countBuyers').textContent = loadBuyers().length; $('countOrders').textContent = loadOrders().length; }

function $(id){ return document.getElementById(id); }

/* ---------- Theme & Apps toggle ---------- */
function changeTheme(cls){ document.body.className = cls + (document.body.classList.contains('dark') ? ' dark' : ''); localStorage.setItem('refit_theme', cls); }
function toggleDark(){ document.body.classList.toggle('dark'); localStorage.setItem('refit_dark', document.body.classList.contains('dark')); }
function initTheme(){
  const saved = localStorage.getItem('refit_theme') || 'theme1';
  $('themeSelect').value = saved;
  document.body.className = saved;
  if(localStorage.getItem('refit_dark') === 'true') document.body.classList.add('dark');
}
function toggleApps(enabled){
  const exportBtn = $('exportJsonBtn');
  exportBtn.disabled = !enabled;
  // store setting
  localStorage.setItem('refit_apps', enabled ? '1' : '0');
}
function initApps(){
  const v = localStorage.getItem('refit_apps') === '1';
  $('appsToggle').checked = v;
  toggleApps(v);
}

/* ---------- Buyers: save / select / delete ---------- */
function updateBuyerSelect(){
  const sel = $('buyerSelect'); sel.innerHTML = '<option value="">-- Select buyer --</option>';
  const buyers = loadBuyers();
  buyers.forEach(b => {
    const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name + (b.reg ? ' â€¢ ' + b.reg : '');
    sel.appendChild(opt);
  });
}

function saveBuyer(){
  const name = $('buyerName').value.trim();
  if(!name){ alert('Please enter buyer name'); return; }
  const buyers = loadBuyers();
  const existingId = $('buyerSelect').value;
  if(existingId){
    // update
    const idx = buyers.findIndex(b=>b.id===existingId);
    if(idx>=0){
      buyers[idx] = {
        id: existingId,
        name,
        reg: $('buyerReg').value.trim(),
        address: $('buyerAddress').value.trim(),
        phone: $('buyerPhone').value.trim(),
        email: $('buyerEmail').value.trim()
      };
    }
  } else {
    buyers.push({ id: uid(), name, reg: $('buyerReg').value.trim(), address: $('buyerAddress').value.trim(), phone: $('buyerPhone').value.trim(), email: $('buyerEmail').value.trim() });
  }
  saveBuyers(buyers);
  alert('Buyer saved locally. It will auto-fill for future invoices.');
  clearBuyerForm();
}

function loadSelectedBuyer(){
  const id = $('buyerSelect').value;
  if(!id){ alert('Please select a saved buyer'); return; }
  const buyers = loadBuyers(); const b = buyers.find(x=>x.id===id);
  if(!b) return;
  $('buyerName').value = b.name; $('buyerReg').value = b.reg; $('buyerAddress').value = b.address;
  $('buyerPhone').value = b.phone; $('buyerEmail').value = b.email;
  checkEnableOrder();
  updatePreview();
}

function deleteSelectedBuyer(){
  const id = $('buyerSelect').value;
  if(!id){ alert('Select a buyer to delete'); return; }
  let buyers = loadBuyers(); buyers = buyers.filter(b=>b.id!==id); saveBuyers(buyers);
  alert('Buyer deleted');
  clearBuyerForm();
}

function clearBuyerForm(){
  $('buyerName').value=''; $('buyerReg').value=''; $('buyerAddress').value=''; $('buyerPhone').value=''; $('buyerEmail').value='';
  $('buyerSelect').value = '';
  checkEnableOrder();
  updatePreview();
}

/* ---------- Items handling ---------- */
function addItem(desc='', uom='EA', qty=1, unit=0){
  const tbody = document.querySelector('#itemsTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td class="small">${tbody.children.length+1}</td>
    <td><input class="itm-desc" value="${desc}"/></td>
    <td><input class="itm-uom" value="${uom}" style="width:80px"/></td>
    <td><input class="itm-qty" type="number" value="${qty}" style="width:80px"/></td>
    <td><input class="itm-unit" type="number" step="0.01" value="${unit.toFixed(2)}" style="width:110px"/></td>
    <td class="itm-total right">RM 0.00</td>
    <td><button class="btn btn-ghost" onclick="this.closest('tr').remove(); updateItems();">Remove</button></td>`;
  tbody.appendChild(tr);
  Array.from(tr.querySelectorAll('input')).forEach(i=>i.addEventListener('input', updateItems));
  updateItems();
}

function readItems(){
  const rows = [...document.querySelectorAll('#itemsTable tbody tr')];
  return rows.map(r=>{
    const desc = r.querySelector('.itm-desc').value || '';
    const uom = r.querySelector('.itm-uom').value || '';
    const qty = Number(r.querySelector('.itm-qty').value) || 0;
    const unit = Number(r.querySelector('.itm-unit').value) || 0;
    return {desc,uom,qty,unit};
  });
}

function updateItems(){
  const items = readItems();
  let subtotal = 0;
  const rows = document.querySelectorAll('#itemsTable tbody tr');
  rows.forEach((r,i)=>{
    const it = items[i]; const total = it.qty * it.unit; subtotal += total;
    r.querySelector('.itm-total').textContent = formatRM(total);
    r.querySelector('td').textContent = i+1;
  });
  const taxRate = Number($('taxRate').value) || 0;
  const tax = +(subtotal * taxRate / 100).toFixed(2);
  const total = +(subtotal + tax).toFixed(2);
  // store totals for preview
  window._calc = {subtotal,tax,total};
  updatePreview();
  checkEnableOrder();
}

/* ---------- Invoice preview / JSON export ---------- */
function formatRM(x){ return 'RM ' + Number(x || 0).toLocaleString('en-MY',{minimumFractionDigits:2,maximumFractionDigits:2}); }

function updatePreview(){
  const info = {
    invoiceNumber: $('invoiceNumber').value,
    invoiceDate: $('invoiceDate').value,
    documentType: $('documentType').value,
    currency: $('currency').value,
    seller: {
      name: 'Refit Maintenance Services', ssm: '201803348973', address: document.querySelector('.header .small')?.textContent || ''
    },
    buyer: {
      name: $('buyerName').value, reg: $('buyerReg').value, address: $('buyerAddress').value, phone: $('buyerPhone').value, email: $('buyerEmail').value
    },
    items: readItems(),
    notes: $('notes').value,
    payment: { bank: $('bankName') ? $('bankName').value : 'RHB Bank', account: '21261100023558' }
  };
  const p = $('previewArea');
  let html = `<div style="font-size:14px"><strong>Invoice:</strong> ${info.invoiceNumber || '(no number)'}<br/><span class="muted small">Date: ${info.invoiceDate || ''}</span></div>`;
  html += `<div style="margin-top:8px"><strong>Bill to:</strong><br/>${escapeHtml(info.buyer.name)}<div class="muted small">${escapeHtml(info.buyer.address).replaceAll('\\n','<br/>')}</div></div>`;
  html += `<table style="width:100%;margin-top:8px"><thead><tr><th>#</th><th>Description</th><th>UOM</th><th>Qty</th><th class="right">Unit (RM)</th><th class="right">Total (RM)</th></tr></thead><tbody>`;
  info.items.forEach((it,i)=>{ html += `<tr><td>${i+1}</td><td>${escapeHtml(it.desc)}</td><td>${escapeHtml(it.uom)}</td><td>${it.qty}</td><td class="right">${(it.unit).toFixed(2)}</td><td class="right">${formatRM(it.qty*it.unit)}</td></tr>`; });
  html += `</tbody></table>`;
  if(window._calc){
    html += `<div style="margin-top:8px"><div style="display:flex;justify-content:space-between"><div>Subtotal</div><div>${formatRM(window._calc.subtotal)}</div></div>
      <div style="display:flex;justify-content:space-between"><div>Tax</div><div>${formatRM(window._calc.tax)}</div></div>
      <div style="display:flex;justify-content:space-between;font-weight:700"><div>Total</div><div>${formatRM(window._calc.total)}</div></div></div>`;
  }
  html += `<div style="margin-top:8px" class="small"><strong>Notes:</strong> ${escapeHtml(info.notes)}</div>`;
  p.innerHTML = html;
}

function exportJSON(){
  const payload = {
    invoiceNumber: $('invoiceNumber').value || ('INV-' + new Date().toISOString().slice(0,10)),
    invoiceDate: $('invoiceDate').value,
    documentType: $('documentType').value,
    currency: $('currency').value,
    seller: { name: 'Refit Maintenance Services', ssm: '201803348973', address: $('logoImg').alt ? '' : '' },
    buyer: { name: $('buyerName').value, reg: $('buyerReg').value, address: $('buyerAddress').value, phone: $('buyerPhone').value, email: $('buyerEmail').value },
    items: readItems(),
    summary: window._calc || {subtotal:0,tax:0,total:0},
    notes: $('notes').value,
    payment: { bank: 'RHB Bank', account: '21261100023558' }
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (payload.invoiceNumber || 'invoice') + '.json'; a.click(); URL.revokeObjectURL(a.href);
}

/* ---------- Orders: place order & storage ---------- */
function placeOrder(){
  // require buyer name
  if(!$('buyerName').value.trim()){ alert('Please enter buyer details before placing order'); return; }
  // prepare order
  const order = {
    id: uid(),
    invoiceNumber: $('invoiceNumber').value || ('INV-' + new Date().toISOString().slice(0,10)),
    date: new Date().toISOString(),
    buyer: { name: $('buyerName').value, reg: $('buyerReg').value, address: $('buyerAddress').value },
    items: readItems(),
    summary: window._calc || {subtotal:0,tax:0,total:0},
    notes: $('notes').value
  };
  const orders = loadOrders(); orders.unshift(order); saveOrders(orders);
  // ensure invoice number saved
  localStorage.setItem(KEY_LAST_INV, order.invoiceNumber);
  alert('Order placed and saved locally. Order ID: ' + order.id);
  updatePreview();
  updateOrdersList();
}

function updateOrdersList(){
  const area = $('ordersList'); area.innerHTML = '';
  const orders = loadOrders();
  if(!orders.length){ area.innerHTML = '<div class="muted small">No saved orders</div>'; updateCounts(); return; }
  orders.slice(0,10).forEach(o=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(0,0,0,0.06)';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(o.invoiceNumber)}</strong> â€¢ ${new Date(o.date).toLocaleString()}</div>
      <div><button class="btn btn-ghost" onclick='loadOrder("${o.id}")'>Load</button></div></div>
      <div class="small muted">${escapeHtml(o.buyer.name)}</div>`;
    area.appendChild(div);
  });
  updateCounts();
}

function loadOrder(id){
  const orders = loadOrders(); const o = orders.find(x=>x.id===id); if(!o) return;
  $('invoiceNumber').value = o.invoiceNumber; $('invoiceDate').value = o.date.slice(0,10);
  $('buyerName').value = o.buyer.name; $('buyerReg').value = o.buyer.reg || ''; $('buyerAddress').value = o.buyer.address || '';
  // load items (replace table)
  const tbody = document.querySelector('#itemsTable tbody'); tbody.innerHTML = '';
  (o.items || []).forEach(it=> addItem(it.desc || it.description || '', it.uom||'EA', it.qty||it.quantity||1, it.unit||it.unitPrice||0));
  updateItems();
  updatePreview();
}

/* ---------- Helpers ---------- */
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\\n','<br/>'); }

function checkEnableOrder(){
  const ok = $('buyerName').value.trim() && readItems().length>0;
  $('orderBtn').disabled = !ok;
  // also enable export if apps active
  const appsActive = localStorage.getItem('refit_apps')==='1';
  $('exportJsonBtn').disabled = !(appsActive && ok);
}

/* ---------- Persistence for invoice defaults ---------- */
function persistInvoiceDefaults(){ localStorage.setItem(KEY_LAST_INV, $('invoiceNumber').value || ''); }

/* ---------- Export / Clear all data ---------- */
function exportAllData(){
  const payload = { buyers: loadBuyers(), orders: loadOrders(), lastInvoice: localStorage.getItem(KEY_LAST_INV) || '' };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'refit_data_export.json'; a.click(); URL.revokeObjectURL(a.href);
}

function clearAllData(){
  if(!confirm('Clear all local saved buyers and orders? This cannot be undone.')) return;
  localStorage.removeItem(KEY_BUYERS); localStorage.removeItem(KEY_ORDERS); localStorage.removeItem(KEY_LAST_INV);
  updateBuyerSelect(); updateOrdersList(); updateCounts();
  alert('Local data cleared.');
}

/* ---------- Initialization ---------- */
function init(){
  initTheme(); initApps();
  updateBuyerSelect(); updateOrdersList(); updateCounts();
  // invoice defaults
  const lastInv = localStorage.getItem(KEY_LAST_INV) || '';
  $('invoiceNumber').value = lastInv || 'INV-2025-221';
  const today = new Date().toISOString().slice(0,10); $('invoiceDate').value = today;
  // sample items
  if(document.querySelectorAll('#itemsTable tbody tr').length===0){
    addItem('Design fee (flat rate)', 'EA', 1, 1200.00);
    addItem('Materials (tiles, paints)', 'EA', 1, 650.00);
    addItem('Labour (installation)', 'HOUR', 8, 80.00);
  }
  updateItems(); updatePreview();
  // wire inputs to persist
  $('invoiceNumber').addEventListener('change', ()=>{ persistInvoiceDefaults(); });
  // apps toggle default state
  const apps = localStorage.getItem('refit_apps') === '1';
  $('appsToggle').checked = apps;
  toggleApps(apps);
}

window.addEventListener('load', init);
function printPreview(){ updatePreview(); window.print(); }

/* simple preview function */
function previewInvoice(){ updatePreview(); alert('Preview updated â€” use Print to save as PDF.'); }

/* reset form */
function resetForm(){ if(!confirm('Reset invoice form?')) return; localStorage.removeItem('refit_temp_invoice'); location.reload(); }

</script>
</body>
</html>
